name: "Copilot Setup Steps"

on:
  # Automatically run the setup steps when they are changed 
  # to allow for easy validation
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  
  # Allow manual testing through the repository's "Actions" tab
  workflow_dispatch:

jobs:
  # NOTE: Copilot requires this exact job name
  copilot-setup-steps:
    # Same as runs-on from build-linux job in ci.yaml
    runs-on: ubuntu-22.04
    
    # Same as latest python-version from build-linux job in ci.yaml
    #python-version: "3.13.5"

    # Lowest permissions needed for steps.
    # Copilot will be given its own token for its operations.
    permissions:
      # Need the `contents: read` permission to clone the repository
      contents: read

    # Steps which run before Copilot Coding Agent starts work
    steps:
      # ========================================================================
      # BEGIN: Duplicate steps from build-linux job in ci.yaml
      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13.5
        uses: actions/setup-python@v5
        with:
          python-version: 3.13.5
      
      # NOTE: Step must be after "Set up Python" so that Poetry installs
      #       itself into that Python
      - name: Install Poetry
        run: |
          python -m pip install -U pip setuptools
          python -m pip install -U "poetry==2.1.1"

      - name: Update APT packages
        run: sudo apt-get update

      # HACK: Suppress warning "Error retrieving accessibility bus
      #       address: org.freedesktop.DBus.Error.ServiceUnknown:
      #       The name org.a11y.Bus was not provided by any .service files"
      #       when running tests later
      - name: Install at-spi2-core
        run: sudo apt-get install -y at-spi2-core
      
      # NOTE: Needed for screenshot support while running tests
      # TODO: Is scrot actually still needed? gnome-screenshot definitely is.
      - name: Install scrot and gnome-screenshot
        run: sudo apt-get install scrot gnome-screenshot

      - name: Install wxPython dependencies
        run: sudo apt-get install -y libgtk-3-dev

      # Install additional dependencies for Python 3.13 wxPython
      - name: Install wxPython dependencies for Python 3.13
        run: sudo apt-get install -y libnotify4

      # Install wxPython from precompiled wagon because installing
      # wxPython from source takes about 40 minutes on GitHub Actions
      # 
      # NOTE: To recompile the .wgn, see instructions in: doc/how_to_make_wxpython_wagon.md
      - name: Install dependency wxPython from wagon (Python 3.13)
        run: |
          poetry run pip3 install wagon
          wget --no-verbose https://github.com/davidfstr/Crystal-Web-Archiver/releases/download/v1.4.0b/wxPython-4.2.3-py313-none-linux_x86_64.wgn
          poetry run wagon install wxPython-4.2.3-py313-none-linux_x86_64.wgn

      - name: Install remaining dependencies with Poetry
        # If build takes a very long time, the precompiled .wgn in the 
        # previous build step may no longer be installing the correct
        # dependency versions that are consistent with pyproject.toml and
        # poetry.lock. In that case you'll need to rebuild the .wgn using
        # instructions from: doc/how_to_make_wxpython_wagon.md
        timeout-minutes: 2  # normally takes 6s, as of 2023-03-03
        run: poetry install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-ubuntu-22.04-${{ hashFiles('**/pyproject.toml') }}

      - name: Install Playwright browsers
        run: poetry run playwright install chromium
      
      # END: Duplicate steps from build-linux job in ci.yaml
      # ========================================================================
